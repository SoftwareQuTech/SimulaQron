
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>simulaqron.virtNode.virtual &#8212; SimulaQron 3.0.14 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SimulaQron 3.0.14 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for simulaqron.virtNode.virtual</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2017, Stephanie Wehner and Axel Dahlberg</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#    documentation and/or other materials provided with the distribution.</span>
<span class="c1"># 3. All advertising materials mentioning features or use of this software</span>
<span class="c1">#    must display the following acknowledgement:</span>
<span class="c1">#    This product includes software developed by Stephanie Wehner, QuTech.</span>
<span class="c1"># 4. Neither the name of the QuTech organization nor the</span>
<span class="c1">#    names of its contributors may be used to endorse or promote products</span>
<span class="c1">#    derived from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY &lt;COPYRIGHT HOLDER&gt; &#39;&#39;AS IS&#39;&#39; AND ANY</span>
<span class="c1"># EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c1"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL &lt;COPYRIGHT HOLDER&gt; BE LIABLE FOR ANY</span>
<span class="c1"># DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="c1"># (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c1"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="c1"># ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1"># (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="c1"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="kn">from</span> <span class="nn">twisted.spread</span> <span class="kn">import</span> <span class="n">pb</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">inlineCallbacks</span><span class="p">,</span> <span class="n">DeferredLock</span><span class="p">,</span> <span class="n">Deferred</span><span class="p">,</span> <span class="n">DeferredList</span>
<span class="kn">from</span> <span class="nn">twisted.internet.task</span> <span class="kn">import</span> <span class="n">deferLater</span>
<span class="kn">from</span> <span class="nn">twisted.internet.error</span> <span class="kn">import</span> <span class="ne">ConnectionRefusedError</span><span class="p">,</span> <span class="n">CannotListenError</span>
<span class="kn">from</span> <span class="nn">twisted.spread.pb</span> <span class="kn">import</span> <span class="n">RemoteError</span>

<span class="kn">from</span> <span class="nn">simulaqron.virtNode.basics</span> <span class="kn">import</span> <span class="n">quantumError</span><span class="p">,</span> <span class="n">noQubitError</span><span class="p">,</span> <span class="n">virtNetError</span>
<span class="kn">from</span> <span class="nn">simulaqron.virtNode.quantum</span> <span class="kn">import</span> <span class="n">simulatedQubit</span>
<span class="kn">from</span> <span class="nn">simulaqron.general.hostConfig</span> <span class="kn">import</span> <span class="n">socketsConfig</span>
<span class="kn">from</span> <span class="nn">simulaqron.settings</span> <span class="kn">import</span> <span class="n">simulaqron_settings</span>

<span class="k">if</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;qutip&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simulaqron.virtNode.qutipSimulator</span> <span class="kn">import</span> <span class="n">qutipEngine</span>
<span class="k">elif</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;projectq&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simulaqron.virtNode.projectQSimulator</span> <span class="kn">import</span> <span class="n">projectQEngine</span>
<span class="k">elif</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;stabilizer&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simulaqron.virtNode.stabilizerSimulator</span> <span class="kn">import</span> <span class="n">stabilizerEngine</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Unknown backend </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span><span class="p">))</span>


<span class="c1">######</span>
<span class="c1">#</span>
<span class="c1"># backEnd - starts the local virtual node and connects to the other virtual nodes</span>
<span class="c1"># forming the quantum network</span>
<span class="c1">#</span>
<div class="viewcode-block" id="backEnd"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.backEnd">[docs]</a><span class="k">class</span> <span class="nc">backEnd</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">virtualFile</span><span class="p">,</span> <span class="n">network_name</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize. This will read the configuration file and populate the name,hostname,port information with the</span>
<span class="sd">        information found in the configuration file for the given name.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Read the configuration file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">socketsConfig</span><span class="p">(</span><span class="n">virtualFile</span><span class="p">,</span> <span class="n">network_name</span><span class="o">=</span><span class="n">network_name</span><span class="p">,</span> <span class="n">config_type</span><span class="o">=</span><span class="s2">&quot;vnode&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">myID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;LOCAL </span><span class="si">{}</span><span class="s2">: No such name in the configuration file </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">virtualFile</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;LOCAL </span><span class="si">{}</span><span class="s2">: Error reading the configuration file </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">virtualFile</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="backEnd.start"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.backEnd.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxQubits</span><span class="o">=</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">max_qubits</span><span class="p">,</span> <span class="n">maxRegisters</span><span class="o">=</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">max_registers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start listening to requests from other nodes.</span>

<span class="sd">        Arguments</span>
<span class="sd">        maxQubits	maximum qubits in the default register</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Starting on port </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">virtualNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">maxQubits</span><span class="o">=</span><span class="n">maxQubits</span><span class="p">,</span> <span class="n">maxRegisters</span><span class="o">=</span><span class="n">maxRegisters</span><span class="p">)</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">listenTCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">PBServerFactory</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: running reactor.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">CannotListenError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;LOCAL </span><span class="si">{}</span><span class="s2">: CQC server address (</span><span class="si">{}</span><span class="s2">) is already in use.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;LOCAL </span><span class="si">{}</span><span class="s2">: Critical error when starting local virtual node server: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span></div></div>


<span class="c1">#######</span>
<span class="c1">#</span>
<span class="c1"># virtualNode - this is the virtual quantum node. It keeps track of registers simulated here, qubits</span>
<span class="c1"># virtually available at this node, etc</span>
<span class="c1">#</span>


<div class="viewcode-block" id="virtualNode"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode">[docs]</a><span class="k">class</span> <span class="nc">virtualNode</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Root</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">maxQubits</span><span class="o">=</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">max_qubits</span><span class="p">,</span>
                 <span class="n">maxRegisters</span><span class="o">=</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">max_registers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize storing also our own name, hostname and port.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        ID		host identifier of this node</span>
<span class="sd">        maxQubits	maximum number of qubits to use in the default engine (default 10)</span>
<span class="sd">        maxRegister	maximum number of registers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Store our own host identifiers and configuration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">myID</span> <span class="o">=</span> <span class="n">ID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

            <span class="c1"># Set max nr of registers and virtual qubits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxRegs</span> <span class="o">=</span> <span class="n">maxRegisters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxQubits</span> <span class="o">=</span> <span class="n">maxQubits</span>

            <span class="c1"># List of connections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Number of registers _created_ at this node</span>
            <span class="c1"># this may not equal the numbers of registers virtually carried</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numRegs</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Counter for used register numbers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_reg_num</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Set up the dictionary of registers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registers</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Initialize the list of qubits at this node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Set up connections to the neighouring nodes in the network</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectNet</span><span class="p">()</span>

            <span class="c1"># Global lock: needs to be acquire whenever we want to manipulate more than one</span>
            <span class="c1"># qubit object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">DeferredLock</span><span class="p">()</span>

            <span class="c1"># Time until retry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delay</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Maximum number of attempts at getting locks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxAttempts</span> <span class="o">=</span> <span class="mi">300</span>

            <span class="c1"># List of qubit received to be polled by CQC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecv</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># List of halves of epr-pairs received to be polled by CQC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecvEpr</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Critical error when initializing virtNode: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="virtualNode.reraise_remote_error"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.reraise_remote_error">[docs]</a>    <span class="k">def</span> <span class="nf">reraise_remote_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a function re-raises the error thrown remotely</span>
<span class="sd">        :param remote_err: :obj:`twisted.spread.pb.RemoteError`</span>
<span class="sd">        :return: class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get name of remote error</span>
        <span class="n">error_name</span> <span class="o">=</span> <span class="n">remote_err</span><span class="o">.</span><span class="n">remoteType</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="c1"># Get class of remote error</span>
        <span class="n">error_class</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">error_name</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">error_class</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remote_err</span><span class="p">))</span></div>

<div class="viewcode-block" id="virtualNode.connectNet"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.connectNet">[docs]</a>    <span class="k">def</span> <span class="nf">connectNet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the connections to the other virtual nodes in the network according to the available</span>
<span class="sd">        configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connect_to_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Critical error when connection network of virtual nodes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="virtualNode.remote_check_connections"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_check_connections">[docs]</a>    <span class="k">def</span> <span class="nf">remote_check_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if all connections are up. (Just checks if the number of</span>
<span class="sd">        connections equal the number of nodes in config-file)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.get_connection"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.get_connection">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the connection specified by &#39;name&#39;. If no such connection is</span>
<span class="sd">        up yet but name is in the configuration file, wait and try again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Connection to </span><span class="si">{}</span><span class="s2"> not up yet, need to wait...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">conn_to_return</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">deferLater</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">conn_retry_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">,</span>
                                                  <span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">conn_to_return</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="virtualNode.connect_to_node"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.connect_to_node">[docs]</a>    <span class="k">def</span> <span class="nf">connect_to_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connects to other node. If node not up yet, waits for CONF_WAIT_TIME seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Trying to connect to node </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">PBClientFactory</span><span class="p">()</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">factory</span><span class="p">)</span>
        <span class="n">defer</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getRootObject</span><span class="p">()</span>
        <span class="n">defer</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_connection</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">defer</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_connection_error</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.handle_connection"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.handle_connection">[docs]</a>    <span class="k">def</span> <span class="nf">handle_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback obtaining twisted root object when connection to the node given by the node details &#39;node&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: New connection to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Retrieve the root object: virtualNode on the remote</span>
            <span class="n">node</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">obj</span>

            <span class="c1"># Add this node to the local connections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Critical error when handling connection to node </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="virtualNode.handle_connection_error"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.handle_connection_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_connection_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles errors from trying to connect to other node.</span>
<span class="sd">        If a ConnectionRefusedError is raised another try will be made after CONF_WAIT_TIME seconds.</span>
<span class="sd">        CONF_WAIT_TIME is set in &#39;settings.py&#39;.</span>
<span class="sd">        Any other error is raised again.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">reason</span><span class="o">.</span><span class="n">raiseException</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ConnectionRefusedError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Could not connect to </span><span class="si">{}</span><span class="s2">, trying again...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">conn_retry_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_to_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Critical error when connection to local virtual node: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="virtualNode.get_virtual_id"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.get_virtual_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_virtual_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a crude and horrible cludge to generate unique IDs for virtual qubits.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Loop through the firt k numbers where k is the number of virtual qubits + 1</span>
        <span class="c1"># Note that this is guaranteed to find a an index which is not yet used</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">used</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">used</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">j</span></div>

<div class="viewcode-block" id="virtualNode.get_sim_id"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.get_sim_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_sim_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similarly, this is a crude and horrible cludge to generate unique IDs for simulated qubits.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Loop through the firt k numbers where k is the number of virtual qubits + 1</span>
        <span class="c1"># Note that this is guaranteed to find a an index which is not yet used</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">used</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">simNum</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">used</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">j</span></div>

    <span class="k">def</span> <span class="nf">_q_num_to_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the simulation number of a qubit simulated here, return the corresponding object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">simNum</span> <span class="o">==</span> <span class="n">num</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">q</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="virtualNode.remote_isLocked"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_isLocked">[docs]</a>    <span class="k">def</span> <span class="nf">remote_isLocked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span></div>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_get_global_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Local GETTING LOCK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Local GOT LOCK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="virtualNode.remote_get_global_lock"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_get_global_lock">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_get_global_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Remote GETTING LOCK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Remote GOT LOCK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_release_global_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Local RELEASE LOCK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="virtualNode.remote_release_global_lock"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_release_global_lock">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_release_global_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Remote RELEASE LOCK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_lock_reg_qubits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Acquire the lock on all qubits in the same register as the local sim qubit qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="n">qubit</span><span class="o">.</span><span class="n">register</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">q</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="virtualNode.remote_lock_reg_qubits"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_lock_reg_qubits">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_lock_reg_qubits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubitNum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Acquire the lock on all qubits in the same register as qubitNum.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_reg_qubits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_num_to_obj</span><span class="p">(</span><span class="n">qubitNum</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_unlock_reg_qubits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release the lock on all qubits in the same register as qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="n">qubit</span><span class="o">.</span><span class="n">register</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">q</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="virtualNode.remote_unlock_reg_qubits"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_unlock_reg_qubits">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_unlock_reg_qubits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubitNum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release the lock on all qubits in the same register as qubitNum.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlock_reg_qubits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_num_to_obj</span><span class="p">(</span><span class="n">qubitNum</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualNode.remote_add_register"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_add_register">[docs]</a>    <span class="k">def</span> <span class="nf">remote_add_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxQubits</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new register to the node..</span>

<span class="sd">        Arguments:</span>
<span class="sd">        maxQubits	maximum number of qubits to use in the default engine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO We have to methods that do the same thing, should deprecate one of them</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_new_register</span><span class="p">(</span><span class="n">maxQubits</span><span class="o">=</span><span class="n">maxQubits</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.get_new_reg_num"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.get_new_reg_num">[docs]</a>    <span class="k">def</span> <span class="nf">get_new_reg_num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an unused register number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reg_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_reg_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_reg_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">reg_num</span></div>

<div class="viewcode-block" id="virtualNode.remote_new_register"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_new_register">[docs]</a>    <span class="k">def</span> <span class="nf">remote_new_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxQubits</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a local register. Right now, this simple creates a register according to the simple engine backend</span>
<span class="sd">        using qubit.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        maxQubits	maximum number of qubits to use in the default engine (default 10)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Make sure that reg numbers are assigned correctly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numRegs</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxRegs</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Maximum number of registers reached.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Maximum number of registers reached.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">numRegs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numRegs</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">regNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_reg_num</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;qutip&quot;</span><span class="p">:</span>
                <span class="n">newReg</span> <span class="o">=</span> <span class="n">qutipEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">regNum</span><span class="p">,</span> <span class="n">maxQubits</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;projectq&quot;</span><span class="p">:</span>
                <span class="n">newReg</span> <span class="o">=</span> <span class="n">projectQEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">regNum</span><span class="p">,</span> <span class="n">maxQubits</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;stabilizer&quot;</span><span class="p">:</span>
                <span class="n">newReg</span> <span class="o">=</span> <span class="n">stabilizerEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">regNum</span><span class="p">,</span> <span class="n">maxQubits</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Unknown backend </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simulaqron_settings</span><span class="o">.</span><span class="n">backend</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span><span class="n">regNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">newReg</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Initializing new simulated register.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Critical error when getting new register: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">newReg</span></div>

<div class="viewcode-block" id="virtualNode.remote_delete_register"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_delete_register">[docs]</a>    <span class="k">def</span> <span class="nf">remote_delete_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the register from the node.</span>
<span class="sd">        Happens if the last qubit in the register is measured out.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get register number</span>
        <span class="n">regnum</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">num</span>

        <span class="c1"># Remove register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">regnum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numRegs</span> <span class="o">-=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="virtualNode.remote_new_qubit"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_new_qubit">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_new_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_max_qubits</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new qubit in the default local register.</span>

<span class="sd">        :param ignore_max_qubits: bool</span>
<span class="sd">            Used to ignore the check if max virtual qubits is reached. This is used when creating EPR pairs</span>
<span class="sd">            to be able to temporarily create a qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to create new qubit.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get a lock to assure IDs are assigned correctly and maxQubits is consitently checked</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxQubits</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ignore_max_qubits</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Maximum number of virtual qubits reached.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">noQubitError</span><span class="p">(</span><span class="s2">&quot;Max virtual qubits reached&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Qubit in the simulation backend, initialized to |0&gt;</span>
                <span class="n">simNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sim_id</span><span class="p">()</span>

                <span class="c1"># Create a new register</span>
                <span class="n">newReg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_add_register</span><span class="p">()</span>

                <span class="c1"># simQubit = simulatedQubit(self.myID, self.defaultReg, simNum)</span>
                <span class="n">simQubit</span> <span class="o">=</span> <span class="n">simulatedQubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">newReg</span><span class="p">,</span> <span class="n">simNum</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">simQubit</span><span class="o">.</span><span class="n">make_fresh</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">noQubitError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Max qubits for register reached.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simQubit</span><span class="p">)</span>

                <span class="c1"># Virtual qubit</span>
                <span class="n">newNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virtual_id</span><span class="p">()</span>
                <span class="n">newQubit</span> <span class="o">=</span> <span class="n">virtualQubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">simQubit</span><span class="p">,</span> <span class="n">newNum</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newQubit</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">newQubit</span></div>

<div class="viewcode-block" id="virtualNode.remote_new_qubit_inreg"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_new_qubit_inreg">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_new_qubit_inreg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new qubit in the specified register reg.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Only allow if the register is local</span>
        <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">simNode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Can only create qubits registers simulated locally by this node.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get a lock to assure IDs are assigned correctly and maxQubits is consitently checked</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxQubits</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Maximum number of virtual qubits reached.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">noQubitError</span><span class="p">(</span><span class="s2">&quot;Max virtual qubits reached&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Qubit in the local simulation backend, initialized to |0&gt;</span>
                <span class="n">simNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sim_id</span><span class="p">()</span>
                <span class="n">simQubit</span> <span class="o">=</span> <span class="n">simulatedQubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">simNum</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">simQubit</span><span class="o">.</span><span class="n">make_fresh</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">noQubitError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Max qubits for register reached.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simQubit</span><span class="p">)</span>

                <span class="c1"># Virtual qubit</span>
                <span class="n">newNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virtual_id</span><span class="p">()</span>
                <span class="n">newQubit</span> <span class="o">=</span> <span class="n">virtualQubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">simQubit</span><span class="p">,</span> <span class="n">newNum</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newQubit</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">newQubit</span></div>

<div class="viewcode-block" id="virtualNode.remote_cqc_send_qubit"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_cqc_send_qubit">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_cqc_send_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">targetName</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">remote_app_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send interface for CQC to add the qubit to the remote nodes received list for an application.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        num		number of virtual qubit to send</span>
<span class="sd">        targetName	name of the node to send to</span>
<span class="sd">        app_id		application asking to have this qubit delivered</span>
<span class="sd">        remote_app_id	application ID to deliver the qubit to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: request to send qubit </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">targetName</span><span class="p">)</span>

        <span class="n">virtQubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_get_virtual_ref</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">newVirtNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_send_qubit</span><span class="p">(</span><span class="n">virtQubit</span><span class="p">,</span> <span class="n">targetName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># Lookup host ID of node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">targetName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">targetName</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">remoteNode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">targetName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># Ask to add to list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">remoteNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;cqc_add_recv_list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">remote_app_id</span><span class="p">,</span> <span class="n">newVirtNum</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualNode.remote_cqc_add_recv_list"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_cqc_add_recv_list">[docs]</a>    <span class="k">def</span> <span class="nf">remote_cqc_add_recv_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">from_app_id</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">,</span> <span class="n">new_virt_num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an item to the received list for use in CQC.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">to_app_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecv</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecv</span><span class="p">[</span><span class="n">to_app_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecv</span><span class="p">[</span><span class="n">to_app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QubitCQC</span><span class="p">(</span><span class="n">fromName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">from_app_id</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">,</span> <span class="n">new_virt_num</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Added a qubit for app id </span><span class="si">%d</span><span class="s2"> to recv list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.remote_cqc_get_recv"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_cqc_get_recv">[docs]</a>    <span class="k">def</span> <span class="nf">remote_cqc_get_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the next qubit with the given app ID form the received list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Trying to retrieve qubit for app id </span><span class="si">%d</span><span class="s2"> from recv list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">to_app_id</span>
        <span class="p">)</span>
        <span class="c1"># Get the list corresponding to the specified application ID</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">to_app_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecv</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">qQueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecv</span><span class="p">[</span><span class="n">to_app_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">qQueue</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Retrieve the first element on that list (first in, first out)</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="n">qQueue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">qc</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Returning qubit for app id </span><span class="si">%d</span><span class="s2"> from recv list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_get_virtual_ref</span><span class="p">(</span><span class="n">qc</span><span class="o">.</span><span class="n">virt_num</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.remote_cqc_send_epr_half"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_cqc_send_epr_half">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_cqc_send_epr_half</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">targetName</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">remote_app_id</span><span class="p">,</span> <span class="n">rawEntInfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send interface for CQC to add the qubit to the remote nodes received list for an application.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        num		number of virtual qubit to send</span>
<span class="sd">        targetName	name of the node to send to</span>
<span class="sd">        app_id		application asking to have this qubit delivered</span>
<span class="sd">        remote_app_id	application ID to deliver the qubit to</span>
<span class="sd">        entInfo		entanglement information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_get_virtual_ref</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">newVirtNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_send_qubit</span><span class="p">(</span><span class="n">qubit</span><span class="p">,</span> <span class="n">targetName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># Lookup host ID of node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">targetName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">targetName</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">remoteNode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">targetName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># Ask to add to list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">remoteNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span>
                <span class="s2">&quot;cqc_add_epr_list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">remote_app_id</span><span class="p">,</span> <span class="n">newVirtNum</span><span class="p">,</span> <span class="n">rawEntInfo</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualNode.remote_cqc_add_epr_list"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_cqc_add_epr_list">[docs]</a>    <span class="k">def</span> <span class="nf">remote_cqc_add_epr_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">from_app_id</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">,</span> <span class="n">new_virt_num</span><span class="p">,</span> <span class="n">rawEntInfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an item to the epr list for use in CQC.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">to_app_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecvEpr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecvEpr</span><span class="p">[</span><span class="n">to_app_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecvEpr</span><span class="p">[</span><span class="n">to_app_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">QubitCQC</span><span class="p">(</span><span class="n">fromName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">from_app_id</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">,</span> <span class="n">new_virt_num</span><span class="p">,</span> <span class="n">rawEntInfo</span><span class="o">=</span><span class="n">rawEntInfo</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Added a qubit for app id </span><span class="si">%d</span><span class="s2"> to epr list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.remote_cqc_get_epr_recv"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_cqc_get_epr_recv">[docs]</a>    <span class="k">def</span> <span class="nf">remote_cqc_get_epr_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the next qubit (half of an EPR-pair) with the given app ID from the received list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Trying to retrieve qubit for app id </span><span class="si">%d</span><span class="s2"> from epr list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">to_app_id</span>
            <span class="p">)</span>
            <span class="c1"># Get the list corresponding to the specified application ID</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">to_app_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecvEpr</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">qQueue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cqcRecvEpr</span><span class="p">[</span><span class="n">to_app_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">qQueue</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Retrieve the first element on that list (first in, first out)</span>
            <span class="n">qc</span> <span class="o">=</span> <span class="n">qQueue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">qc</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Returning qubit for app id </span><span class="si">%d</span><span class="s2"> from epr list&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_get_virtual_ref</span><span class="p">(</span><span class="n">qc</span><span class="o">.</span><span class="n">virt_num</span><span class="p">),</span> <span class="n">qc</span><span class="o">.</span><span class="n">rawEntInfo</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="virtualNode.remote_send_qubit"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_send_qubit">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_send_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit</span><span class="p">,</span> <span class="n">targetName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the qubit to the specified target node. This creates a new virtual qubit object at the remote node</span>
<span class="sd">        with the right qubit and backend details.</span>

<span class="sd">        Arguments</span>
<span class="sd">        qubit		virtual qubit to be sent</span>
<span class="sd">        targetName	target ndoe to place qubit at (host object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to send qubit sim Num </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">qubit</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="n">targetName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qubit</span><span class="o">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Attempt to manipulate qubit no longer at this node.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Lookup host id of node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">targetName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">targetName</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">remoteNode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">targetName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get lock to prevent access to qubits between sending and manipulating local list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>

            <span class="c1"># Check whether we are just the virtual, or also the simulating node</span>
            <span class="k">if</span> <span class="n">qubit</span><span class="o">.</span><span class="n">virtNode</span> <span class="o">==</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Sending qubit simulated locally&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># We are both the virtual as well as the simulating node</span>
                <span class="c1"># Pass a reference to our locally simulated qubit object to the remote node</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">newNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">remoteNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;add_qubit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Sending qubit simulated remotely at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
                <span class="c1"># We are only the virtual node, not the simulating one. In this case, we need to ask</span>
                <span class="c1"># the actual simulating node to do the transfer for us. Due to the pecularities of Twisted PB</span>
                <span class="c1"># we need to do this by the simulated qubit number</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">simQubitNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_sim_number&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">newNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;transfer_qubit&quot;</span><span class="p">,</span> <span class="n">simQubitNum</span><span class="p">,</span> <span class="n">targetName</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>

            <span class="c1"># We gave it away so mark as inactive</span>
            <span class="n">qubit</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Remove the qubit from the local virtual list. Note it remains in the simulated</span>
            <span class="c1"># list, since we continue to simulate this qubit if we did so before.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">qubit</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">newNum</span></div>

<div class="viewcode-block" id="virtualNode.remote_transfer_qubit"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_transfer_qubit">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_transfer_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simQubitNum</span><span class="p">,</span> <span class="n">targetName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer the qubit to the destination node if we are the simulating node. The reason why we cannot</span>
<span class="sd">        do this directly is that Twisted PB does not allow objects to be passed between connecting nodes.</span>
<span class="sd">        Only between the creator of the object and its immediate connections.</span>

<span class="sd">        Arguments</span>
<span class="sd">        simQubitNum	simulated qubit number to be sent</span>
<span class="sd">        targetName	target node to place qubit at (host object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to transfer qubit to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">targetName</span><span class="p">)</span>

        <span class="c1"># Convert the number into the right local object</span>
        <span class="n">simQubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_num_to_obj</span><span class="p">(</span><span class="n">simQubitNum</span><span class="p">)</span>

        <span class="c1"># Lookup host id of node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">targetName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">targetName</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">remoteNode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">targetName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># Check if we are both the destination node and simulating node</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">targetName</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">remoteNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">remote_add_qubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">simQubit</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">remoteNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;add_qubit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">simQubit</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">newNum</span></div>

<div class="viewcode-block" id="virtualNode.remote_add_qubit"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_add_qubit">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_add_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">simQubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a qubit to the local virtual node.</span>

<span class="sd">        Arguments</span>
<span class="sd">        name		name of the node simulating this qubit</span>
<span class="sd">        simQubit 	simulated qubit reference in the backend we&#39;re adding</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to add qubit from </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Get the details of the remote node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get a lock to make sure IDs are assigned correctly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxQubits</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">noQubitError</span><span class="p">(</span><span class="s2">&quot;Max virtual qubits reached&quot;</span><span class="p">)</span>

            <span class="c1"># Generate a new virtual qubit object for the qubit now at this node</span>
            <span class="n">newNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_virtual_id</span><span class="p">()</span>
            <span class="n">newQubit</span> <span class="o">=</span> <span class="n">virtualQubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">simQubit</span><span class="p">,</span> <span class="n">newNum</span><span class="p">)</span>

            <span class="c1"># Add to local list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newQubit</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">newNum</span></div>

<div class="viewcode-block" id="virtualNode.remote_get_virtual_ref"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_get_virtual_ref">[docs]</a>    <span class="k">def</span> <span class="nf">remote_get_virtual_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a virual qubit object for the given number.</span>

<span class="sd">        Arguments</span>
<span class="sd">        num		number of the virtual qubit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="n">num</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">q</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="virtualNode.remote_remove_sim_qubit_num"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_remove_sim_qubit_num">[docs]</a>    <span class="k">def</span> <span class="nf">remote_remove_sim_qubit_num</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delNum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the simulated qubit delQubit from the node and also from the underlying engine. Relies on this qubit</span>
<span class="sd">        having been locked.</span>

<span class="sd">        Arguments</span>
<span class="sd">        delNum		simID of the simulated qubit to delete</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_sim_qubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_num_to_obj</span><span class="p">(</span><span class="n">delNum</span><span class="p">))</span></div>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_remove_sim_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delQubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the simulated qubit object.</span>

<span class="sd">        Arguments</span>
<span class="sd">        delQubit	simulated qubit object to delete</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Caution: Only qubits simulated at this node can be removed</span>
        <span class="k">if</span> <span class="n">delQubit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Attempt to delete qubit not simulated at this node.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Cannot delete qubits we don&#39;t simulate.&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="n">delNum</span> <span class="o">=</span> <span class="n">delQubit</span><span class="o">.</span><span class="n">num</span>
        <span class="n">delRegister</span> <span class="o">=</span> <span class="n">delQubit</span><span class="o">.</span><span class="n">register</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We need to manipulate multiple qubits, get global lock</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>

            <span class="c1"># Lock all relevant qubits first</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="n">delRegister</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">q</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>

            <span class="c1"># First we remove the physical qubit from the register</span>
            <span class="n">delRegister</span><span class="o">.</span><span class="n">remove_qubit</span><span class="p">(</span><span class="n">delNum</span><span class="p">)</span>

            <span class="c1"># Check if this was the last qubit</span>
            <span class="k">if</span> <span class="n">delRegister</span><span class="o">.</span><span class="n">activeQubits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_delete_register</span><span class="p">(</span><span class="n">delRegister</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># When removing a qubit, we need to update the positions of the qubits in</span>
                <span class="c1"># the underlying physical register</span>
                <span class="c1"># in all relevant qubit objects.</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
                    <span class="c1"># If they are in the same engine, and update is required</span>
                    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="n">delRegister</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">delNum</span><span class="p">:</span>
                            <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># Remove the qubit form the list of simulated qubits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">delQubit</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Cannot remove sim qubit - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Release all relevant qubits again</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="n">delRegister</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>

            <span class="c1"># Release the global multi qubit lock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>

<div class="viewcode-block" id="virtualNode.remote_merge_regs"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_merge_regs">[docs]</a>    <span class="k">def</span> <span class="nf">remote_merge_regs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges the two local quantum registers. Note that these register may simulate virtual qubits across different</span>
<span class="sd">        network nodes. This will ignore maxQubits and simply create one large register allowing twice maxQubits qubits.</span>

<span class="sd">        Arguments</span>
<span class="sd">        num1 		number of the first qubit</span>
<span class="sd">        num2		number of the second qubit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Lookup the qubit objects corresponding to these numbers</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">simNum</span> <span class="o">==</span> <span class="n">num1</span><span class="p">:</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="n">q</span>
            <span class="k">elif</span> <span class="n">q</span><span class="o">.</span><span class="n">simNum</span> <span class="o">==</span> <span class="n">num2</span><span class="p">:</span>
                <span class="n">q2</span> <span class="o">=</span> <span class="n">q</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">local_merge_regs</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.local_merge_regs"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.local_merge_regs">[docs]</a>    <span class="k">def</span> <span class="nf">local_merge_regs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit1</span><span class="p">,</span> <span class="n">qubit2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges the two local quantum registers. Note that these register may simulate virtual qubits across different</span>
<span class="sd">        network nodes. This will ignore maxQubits and simply create one large register allowing twice maxQubits qubits.</span>

<span class="sd">        Arguments</span>
<span class="sd">        qubit1		qubit1 in reg1, called from remote having access to only qubits</span>
<span class="sd">        qubit2		qubit2 in reg2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to merge local register for qubits simNum </span><span class="si">%d</span><span class="s2"> and simNum </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">qubit1</span><span class="o">.</span><span class="n">simNum</span><span class="p">,</span>
            <span class="n">qubit2</span><span class="o">.</span><span class="n">simNum</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># This should only be called if locks are acquired</span>
        <span class="k">assert</span> <span class="n">qubit1</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span>
        <span class="k">assert</span> <span class="n">qubit2</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to merge LOCKS PRESENT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">reg1</span> <span class="o">=</span> <span class="n">qubit1</span><span class="o">.</span><span class="n">register</span>
        <span class="n">reg2</span> <span class="o">=</span> <span class="n">qubit2</span><span class="o">.</span><span class="n">register</span>

        <span class="c1"># Check if there&#39;s anything to do at all</span>
        <span class="k">if</span> <span class="n">reg1</span> <span class="o">==</span> <span class="n">reg2</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to merge local register: not required&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to merge local register: need merge&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Allow reg 1 to absorb reg 2</span>
        <span class="n">reg1</span><span class="o">.</span><span class="n">maxQubits</span> <span class="o">=</span> <span class="n">reg1</span><span class="o">.</span><span class="n">maxQubits</span> <span class="o">+</span> <span class="n">reg2</span><span class="o">.</span><span class="n">activeQubits</span>

        <span class="c1"># For relabelling qubit numbers get the offset</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">reg1</span><span class="o">.</span><span class="n">activeQubits</span>

        <span class="c1"># Add reg2 to reg1</span>
        <span class="n">reg1</span><span class="o">.</span><span class="n">absorb</span><span class="p">(</span><span class="n">reg2</span><span class="p">)</span>

        <span class="c1"># Update the simulated qubit numbering and register</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="n">reg2</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Updating register </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
                <span class="n">q</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">reg1</span>
                <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">num</span> <span class="o">+</span> <span class="n">offset</span>

        <span class="c1"># reg2.reset()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_delete_register</span><span class="p">(</span><span class="n">reg2</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.remote_merge_from"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_merge_from">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_merge_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simNodeName</span><span class="p">,</span> <span class="n">simQubitNum</span><span class="p">,</span> <span class="n">localReg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bring a remote register to this node.</span>

<span class="sd">        Arguments</span>
<span class="sd">        simNodeName	name of the node who simulates right now</span>
<span class="sd">        simQubitNum	simulation number of qubit whose register we will merge</span>
<span class="sd">        localReg	local register to merge with</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Merging from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">simNodeName</span><span class="p">)</span>

        <span class="c1"># This should only be called if lock is acquired</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Merging from </span><span class="si">%s</span><span class="s2"> LOCKS PRESENT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">simNodeName</span><span class="p">)</span>

        <span class="c1"># Lookup the local connection for this simulating node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">simNodeName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">simNodeName</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">simNode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">simNodeName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># Fetch the details of the remote register and qubit, and remove sim qubits at node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">activeQ</span><span class="p">,</span> <span class="n">oldRegNum</span><span class="p">,</span> <span class="n">oldQubitNum</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_register_del&quot;</span><span class="p">,</span> <span class="n">simQubitNum</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># Get numbering offset from previous register: append at end</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">localReg</span><span class="o">.</span><span class="n">activeQubits</span>

        <span class="c1"># Allow localReg to absorb the remote register</span>
        <span class="n">localReg</span><span class="o">.</span><span class="n">maxQubits</span> <span class="o">=</span> <span class="n">localReg</span><span class="o">.</span><span class="n">maxQubits</span> <span class="o">+</span> <span class="n">activeQ</span>
        <span class="n">localReg</span><span class="o">.</span><span class="n">absorb_parts</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">activeQ</span><span class="p">)</span>

        <span class="c1"># Collect mappings between numbers and objects for updating the virtual qubits</span>
        <span class="n">newD</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Make new qubit objects</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">activeQ</span><span class="p">):</span>
            <span class="n">simNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sim_id</span><span class="p">()</span>
            <span class="n">newQubit</span> <span class="o">=</span> <span class="n">simulatedQubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">localReg</span><span class="p">,</span> <span class="n">simNum</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newQubit</span><span class="p">)</span>
            <span class="n">newD</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">newQubit</span>

        <span class="c1"># Issue an update call to all nodes to update their virtual qubits if necessary</span>
        <span class="c1"># for name in self.conn:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nb</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">nb</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;update_virtual_merge&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">simNodeName</span><span class="p">,</span> <span class="n">oldRegNum</span><span class="p">,</span> <span class="n">newD</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># Locally, we might also already have virtual qubits which were in the remote simulated</span>
        <span class="c1"># register. Update them as well</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Updating local virtual qubits.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_update_virtual_merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">simNodeName</span><span class="p">,</span> <span class="n">oldRegNum</span><span class="p">,</span> <span class="n">newD</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># Return the qubit object corresponding to the new physical qubit</span>
        <span class="k">return</span> <span class="n">newD</span><span class="p">[</span><span class="n">oldQubitNum</span><span class="p">]</span></div>

<div class="viewcode-block" id="virtualNode.remote_update_virtual_merge"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_update_virtual_merge">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_update_virtual_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newSimNodeName</span><span class="p">,</span> <span class="n">oldSimNodeName</span><span class="p">,</span> <span class="n">oldRegNum</span><span class="p">,</span> <span class="n">newD</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the virtual qubits to the new simulating node, if applicable. This is extremely</span>
<span class="sd">        inefficient due to not keeping register information in virtualQubit.</span>

<span class="sd">        Arguments</span>
<span class="sd">        newSimNodeName	new node simulating this qubit</span>
<span class="sd">        oldSimNodeName	old node simulating the qubit</span>
<span class="sd">        oldReg		old register</span>
<span class="sd">        newD		dictionary mapping qubit numbers to qubit objects at the new simulating node</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Request to update local virtual qubits.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># If this is a third node (not involved in the two qubit gate, but carrying virtual qubits</span>
        <span class="c1"># which were in the simulated register), then they will now be updated. We remark that this function</span>
        <span class="c1"># can only be called from the _simulating node_ now handing over simulation to someone else. Both the simulating</span>
        <span class="c1"># node and the new simulating node are globally locked so there should be no conflicts here in updating:</span>
        <span class="c1"># a third node that may wish to do a 2 qubit gate between the qubits to be updated needs to wait.</span>

        <span class="c1"># Lookup the local connections for the given node names</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">newSimNodeName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">newSimNodeName</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">oldSimNodeName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hostDict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">virtNetError</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to get conncetion to virtual node </span><span class="si">{}</span><span class="s2">, but this is not in configuration file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">oldSimNodeName</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">newSimNode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">newSimNodeName</span><span class="p">)</span>
            <span class="n">oldSimNode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">oldSimNodeName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">virtNode</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">simNode</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">oldSimNode</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Simulating node update.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># We previously simulated this qubit ourselves</span>
                <span class="n">givenReg</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">num</span>
                <span class="n">givenNum</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span>
            <span class="k">elif</span> <span class="n">q</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">oldSimNode</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Previously remote simulator node update.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># We had the virtual qubit but it was simulated elsewhere</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">givenNum</span><span class="p">,</span> <span class="n">givenReg</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">q</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_numbers&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>

            <span class="c1"># Check if this qubit needs updating</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">oldSimNode</span> <span class="ow">and</span> <span class="n">givenReg</span> <span class="o">==</span> <span class="n">oldRegNum</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Updating virtual qubit </span><span class="si">%d</span><span class="s2">, previously </span><span class="si">%s</span><span class="s2"> now </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">num</span><span class="p">,</span>
                    <span class="n">oldSimNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">newSimNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">q</span><span class="o">.</span><span class="n">simNode</span> <span class="o">=</span> <span class="n">newSimNode</span>
                <span class="n">q</span><span class="o">.</span><span class="n">simQubit</span> <span class="o">=</span> <span class="n">newD</span><span class="p">[</span><span class="n">givenNum</span><span class="p">]</span></div>

<div class="viewcode-block" id="virtualNode.remote_get_register_RI"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_get_register_RI">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_get_register_RI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the real and imaginary part of the (possibly remote) simulated register which</span>
<span class="sd">        contains this virtual qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qubit</span><span class="p">,</span> <span class="n">virtualQubit</span><span class="p">):</span>
            <span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">remote_get_register_RI</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_register_RI&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span></div>

<div class="viewcode-block" id="virtualNode.remote_get_register"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_get_register">[docs]</a>    <span class="k">def</span> <span class="nf">remote_get_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of of a locally simulated register which contains this virtual qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span><span class="p">)</span> <span class="o">=</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">get_register_RI</span><span class="p">()</span>
        <span class="n">activeQ</span> <span class="o">=</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">activeQubits</span>
        <span class="n">oldRegNum</span> <span class="o">=</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">num</span>
        <span class="n">oldQubitNum</span> <span class="o">=</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span><span class="p">,</span> <span class="n">activeQ</span><span class="p">,</span> <span class="n">oldRegNum</span><span class="p">,</span> <span class="n">oldQubitNum</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.remote_get_register_del"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_get_register_del">[docs]</a>    <span class="k">def</span> <span class="nf">remote_get_register_del</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubitNum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of of a locally simulated register, and remove the simulated qubits from this node.</span>

<span class="sd">        Caution: virtual qubits not updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span>

        <span class="c1"># Locate the qubit object for this ID</span>
        <span class="n">gotQ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">simNum</span> <span class="o">==</span> <span class="n">qubitNum</span><span class="p">:</span>
                <span class="n">gotQ</span> <span class="o">=</span> <span class="n">q</span>

        <span class="c1"># If nothing is found, return</span>
        <span class="k">if</span> <span class="n">gotQ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: No simulated qubit with ID </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">qubitNum</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">([],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="p">(</span><span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span><span class="p">)</span> <span class="o">=</span> <span class="n">gotQ</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">get_register_RI</span><span class="p">()</span>
        <span class="n">activeQ</span> <span class="o">=</span> <span class="n">gotQ</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">activeQubits</span>
        <span class="n">oldRegNum</span> <span class="o">=</span> <span class="n">gotQ</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">num</span>
        <span class="n">oldQubitNum</span> <span class="o">=</span> <span class="n">gotQ</span><span class="o">.</span><span class="n">num</span>
        <span class="n">delRegister</span> <span class="o">=</span> <span class="n">gotQ</span><span class="o">.</span><span class="n">register</span>

        <span class="c1"># Remove all simulated qubits and the register</span>
        <span class="c1"># Need to iterate of simQubits in reverse, otherwise wrong elements are removed</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="n">oldRegNum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="c1"># gotQ.register.activeQubits -= 1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remote_delete_register</span><span class="p">(</span><span class="n">delRegister</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span><span class="p">,</span> <span class="n">activeQ</span><span class="p">,</span> <span class="n">oldRegNum</span><span class="p">,</span> <span class="n">oldQubitNum</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.remote_get_multiple_qubits"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_get_multiple_qubits">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_get_multiple_qubits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the state of multiple qubits virtually located at this node. This will fail if the qubits</span>
<span class="sd">        are not in the same register or thus also simulating node.</span>

<span class="sd">        Arguments</span>
<span class="sd">        qList		list of virtual qubits of which to retrieve the state</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">localSim</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">remoteSim</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check whether we are the simulating node.</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                <span class="n">localSim</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">q</span><span class="o">.</span><span class="n">simNode</span> <span class="o">!=</span> <span class="n">q</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                <span class="n">remoteSim</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check whether two nodes are the simulator, for now we simply fail in this case</span>
        <span class="k">if</span> <span class="n">localSim</span> <span class="ow">and</span> <span class="n">remoteSim</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Getting multiple qubits from multiple simulators is currently not supported.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">localSim</span><span class="p">:</span>
            <span class="c1"># Qubits are local, simply retrieve from the simulation</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qList</span><span class="p">:</span>
                <span class="n">nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">simNum</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Looking for simulated qubits. </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">nums</span><span class="p">)</span>
            <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_get_state</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Qubits are located elsewhere.</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qList</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">q</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_details&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="n">nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">qList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_state&quot;</span><span class="p">,</span> <span class="n">nums</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualNode.remote_get_state"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualNode.remote_get_state">[docs]</a>    <span class="k">def</span> <span class="nf">remote_get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simNumList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the state of multiple qubits corresponding to the IDs in simNumList.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert simulation numbers to register and real number in register</span>
        <span class="n">traceList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">foundOne</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">simNumList</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">simNum</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">foundOne</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">prev</span><span class="o">.</span><span class="n">register</span> <span class="o">!=</span> <span class="n">q</span><span class="o">.</span><span class="n">register</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Getting multiple qubits from different registers not supported.&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="p">([],</span> <span class="p">[])</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">q</span>
                    <span class="n">foundOne</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">traceList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">foundOne</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: No such qubits found.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">traceList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="p">(</span><span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span><span class="p">)</span> <span class="o">=</span> <span class="n">prev</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">get_qubits_RI</span><span class="p">(</span><span class="n">traceList</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span><span class="p">)</span></div></div>


<span class="c1">#######</span>
<span class="c1">#</span>
<span class="c1"># virtualQubit - a qubit that is virtually carried at this node. It may be simulated elsewhere</span>
<span class="c1"># but in the simulation it is located at this particular virtualNode.</span>
<span class="c1">#</span>
<span class="c1"># This is given out as a reference object to users who ask for a &quot;local&quot; qubit</span>
<span class="c1">#</span>
<span class="c1">#</span>


<div class="viewcode-block" id="virtualQubit"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit">[docs]</a><span class="k">class</span> <span class="nc">virtualQubit</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">virtNode</span><span class="p">,</span> <span class="n">simNode</span><span class="p">,</span> <span class="n">simQubit</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a virtual qubit object simulated in the specified simulation register backend</span>

<span class="sd">        Arguments</span>
<span class="sd">        virtNode	node where this qubit is virtually located</span>
<span class="sd">        simNode		node where this qubit is simulated</span>
<span class="sd">        simQubit	reference to the underlying qubit object (may be remote)</span>
<span class="sd">        num		number ID among the virtual qubits</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Node where this qubit is virtually located</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span> <span class="o">=</span> <span class="n">virtNode</span>

        <span class="c1"># Node where this qubit is being simulated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span> <span class="o">=</span> <span class="n">simNode</span>

        <span class="c1"># Underlying qubit object for simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span> <span class="o">=</span> <span class="n">simQubit</span>

        <span class="c1"># Qubit active at this node. The client may retain a reference to this object,</span>
        <span class="c1"># which will cause python to keep it, while it has actually be transferred to</span>
        <span class="c1"># another node. We do not allow operations on a qubit that is now virtually elsewhere.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Our number at this virtual node. Note that this has nothing to do</span>
        <span class="c1"># with the number of the qubits in the register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_single_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the single gate function to the underlying qubit. This is an internal method used by all the other</span>
<span class="sd">        single qubit calls, which will perform the correct local or remote method calls as applicable after</span>
<span class="sd">        performing the necessary locking.</span>

<span class="sd">        Arguments</span>
<span class="sd">        name		name of the method corresponding to the name. For example: name = apply_X</span>
<span class="sd">        param		parameters for gates such as rotations (axis,angle)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Attempt to manipulate qubits no longer at this node.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Construct the name of the method to call if the qubit is locally simulated</span>
        <span class="c1"># in which case we (ironically) need to append the prefix remote which is automatically</span>
        <span class="c1"># added if the method is called from remote by Twisted</span>
        <span class="n">localName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;remote_&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>

        <span class="c1"># Check whether the qubit is local or remote. Due to remote register merges, this may change</span>
        <span class="c1"># while we try and get a lock. For this reason, we have to wait until we have a lock on an _active_</span>
        <span class="c1"># qubit before proceeding. If it is no longer active when we get the lock, then it has been</span>
        <span class="c1"># moved elsewhere in the meantime and we need to wait for the remote message to update the virtual</span>
        <span class="c1"># qubit object in the background.</span>
        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">waiting</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">isLocked</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">,</span> <span class="n">localName</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                            <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">outcome</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Cannot apply </span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">isLocked</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;isLocked&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isLocked</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;lock&quot;</span><span class="p">)</span>
                        <span class="n">active</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;isActive&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Calling </span><span class="si">%s</span><span class="s2"> remotely to apply </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">name</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                            <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">outcome</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Cannot apply </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;unlock&quot;</span><span class="p">)</span>

            <span class="c1"># If we did not get a lock on an active qubit, wait for update and try again</span>
            <span class="k">if</span> <span class="n">waiting</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">deferLater</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_delay</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">outcome</span>

<div class="viewcode-block" id="virtualQubit.remote_apply_X"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_apply_X">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_apply_X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply X gate to itself by passing it onto the underlying register.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_gate</span><span class="p">(</span><span class="s2">&quot;apply_X&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_apply_Y"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_apply_Y">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_apply_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply Y gate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_gate</span><span class="p">(</span><span class="s2">&quot;apply_Y&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_apply_Z"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_apply_Z">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_apply_Z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply Z gate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_gate</span><span class="p">(</span><span class="s2">&quot;apply_Z&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_apply_H"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_apply_H">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_apply_H</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply H gate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_gate</span><span class="p">(</span><span class="s2">&quot;apply_H&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_apply_K"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_apply_K">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_apply_K</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply K gate - taking computational basis to Y eigenbasis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_gate</span><span class="p">(</span><span class="s2">&quot;apply_K&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_apply_T"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_apply_T">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_apply_T</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply T gate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_gate</span><span class="p">(</span><span class="s2">&quot;apply_T&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_apply_rotation"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_apply_rotation">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_apply_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply rotation around axis n with angle a.</span>
<span class="sd">        Arguments:</span>
<span class="sd">        n	A tuple of three numbers specifying the rotation axis, e.g n=(1,0,0)</span>
<span class="sd">        a	The rotation angle in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_gate</span><span class="p">(</span><span class="s2">&quot;apply_rotation&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_measure"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_measure">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure the qubit in the standard basis. If inplace=False, this does delete the qubit from the simulation.</span>

<span class="sd">        Returns the measurement outcome.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Attempt to manipulate qubits no longer at this node.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Check whether the qubit is local or remote. Due to remote register merges, this may change</span>
        <span class="c1"># while we try and get a lock. For this reason, we have to wait until we have a lock on an _active_</span>
        <span class="c1"># qubit before proceeding.</span>
        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">waiting</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">isLocked</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Measuring local qubit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="n">outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">remote_measure_inplace</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_remove_sim_qubit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">)</span>

                                <span class="c1"># Delete from virtual qubits</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">virtQubits</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                            <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Cannot remove local qubit. Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">isLocked</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;isLocked&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isLocked</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;lock&quot;</span><span class="p">)</span>
                        <span class="n">active</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;isActive&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Measuring remote qubit at </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span>
                            <span class="p">)</span>
                            <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;measure_inplace&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
                                <span class="n">num</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_sim_number&quot;</span><span class="p">)</span>
                                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;remove_sim_qubit_num&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

                                <span class="c1"># Delete from virtual qubits</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">virtQubits</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                            <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Cannot remove remote qubit. Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;unlock&quot;</span><span class="p">)</span>

            <span class="c1"># If we did not get a lock on an active qubit, wait for update and try again</span>
            <span class="k">if</span> <span class="n">waiting</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">deferLater</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_delay</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">outcome</span></div>

    <span class="k">def</span> <span class="nf">_lock_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper to acquire the global register lock on both nodes that involve the qubits, and local node.</span>

<span class="sd">        Arguments</span>
<span class="sd">        target		virtual qubit of the target qubit</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lockedLocal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lockedRemoteTarget</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Lock qubits nodes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
            <span class="c1"># first qubit is locally simulated</span>
            <span class="n">def1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>
            <span class="n">lockedLocal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># first qubit is remote</span>
            <span class="n">def1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_global_lock&quot;</span><span class="p">)</span>

        <span class="c1"># If target is a different node</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                <span class="c1"># target qubit is local</span>
                <span class="n">def2</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>
                <span class="n">lockedLocal</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># target qubit is remote</span>
                <span class="n">def2</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_global_lock&quot;</span><span class="p">)</span>
                <span class="n">lockedRemoteTarget</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lockedLocal</span><span class="p">:</span>
            <span class="n">def0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_get_global_lock</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">lockedRemoteTarget</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DeferredList</span><span class="p">([</span><span class="n">def0</span><span class="p">,</span> <span class="n">def1</span><span class="p">,</span> <span class="n">def2</span><span class="p">],</span> <span class="n">fireOnOneCallback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">consumeErrors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DeferredList</span><span class="p">([</span><span class="n">def0</span><span class="p">,</span> <span class="n">def1</span><span class="p">],</span> <span class="n">fireOnOneCallback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">consumeErrors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lockedRemoteTarget</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DeferredList</span><span class="p">([</span><span class="n">def1</span><span class="p">,</span> <span class="n">def2</span><span class="p">],</span> <span class="n">fireOnOneCallback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">consumeErrors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DeferredList</span><span class="p">([</span><span class="n">def1</span><span class="p">],</span> <span class="n">fireOnOneCallback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">consumeErrors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_unlock_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q1simNode</span><span class="p">,</span> <span class="n">q1virtNode</span><span class="p">,</span> <span class="n">q2simNode</span><span class="p">,</span> <span class="n">q2virtNode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper to acquire the global register lock on both nodes that involve the qubits. This takes different</span>
<span class="sd">        arguments as lock nodes since we wish to call it with the _original_ simulated and target nodes from</span>
<span class="sd">        which we got the lock - not the updated ones.</span>

<span class="sd">        Arguments</span>
<span class="sd">        q1simNode	original simulating node of the first qubit</span>
<span class="sd">        q1virtNode	original virtual node of the first qubit</span>
<span class="sd">        q2simNode	original simulating node of the second qubit</span>
<span class="sd">        q2virtNode	original virtual node of the second qubit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Release qubit node locks</span>
            <span class="k">if</span> <span class="n">q1simNode</span> <span class="o">==</span> <span class="n">q1virtNode</span><span class="p">:</span>
                <span class="c1"># first qubit was locally simulated</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># first qubit was remote</span>
                <span class="k">yield</span> <span class="n">q1simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;release_global_lock&quot;</span><span class="p">)</span>

            <span class="c1"># If target was a different node</span>
            <span class="k">if</span> <span class="n">q1simNode</span> <span class="o">!=</span> <span class="n">q2simNode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q2simNode</span> <span class="o">==</span> <span class="n">q2virtNode</span><span class="p">:</span>
                    <span class="c1"># target qubit was local</span>
                    <span class="k">yield</span> <span class="n">q2simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># target qubit was remote</span>
                    <span class="k">yield</span> <span class="n">q2simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;release_global_lock&quot;</span><span class="p">)</span>

            <span class="c1"># Release local node (may be the same as above)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_release_global_lock</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_lock_inreg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lock all qubits in the same register as the virtual qubit qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">qubit</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_lock_reg_qubits</span><span class="p">(</span><span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">simNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_sim_number&quot;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;lock_reg_qubits&quot;</span><span class="p">,</span> <span class="n">simNum</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_unlock_inreg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qubit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lock all qubits in the same register as the virtual qubit qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">qubit</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_unlock_reg_qubits</span><span class="p">(</span><span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">simNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_sim_number&quot;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">qubit</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;unlock_reg_qubits&quot;</span><span class="p">,</span> <span class="n">simNum</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="virtualQubit.remote_cnot_onto"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_cnot_onto">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_cnot_onto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a CNOT operation with this qubit as control, and the other qubit as target.</span>

<span class="sd">        Arguments</span>
<span class="sd">        target		the virtual qubit to use as the target of the CNOT</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_two_qubit_gate</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;cnot_onto&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="virtualQubit.remote_cphase_onto"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_cphase_onto">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_cphase_onto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a CPHASE operation with this qubit as control, and the other qubit as target.</span>

<span class="sd">        Arguments</span>
<span class="sd">        target		the virtual qubit to use as the target of the CPHASE</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_two_qubit_gate</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;cphase_onto&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">_two_qubit_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a two qubit gate including all the required locking.</span>

<span class="sd">        Arguments</span>
<span class="sd">        target		second virtual qubit (beyond self which is the first)</span>
<span class="sd">        name		name of the gate to perform</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">target</span><span class="o">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Attempt to manipulate qubits no longer at this node.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">localName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;remote_&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Doing 2 qubit gate name </span><span class="si">%s</span><span class="s2"> and local call </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">localName</span>
        <span class="p">)</span>

        <span class="c1"># Before we proceed, we need to acquire the gobal locks of the nodes holding the</span>
        <span class="c1"># registers of both qubits. We wrap this in a timeout with random repeat since there is</span>
        <span class="c1"># otherwise the possibility of a deadlock if two nodes compete for the _two_ locks</span>
        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">waiting</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">maxAttempts</span><span class="p">:</span>

                <span class="c1"># Set up the timeout at a random time between 1s and 4s later</span>
                <span class="n">timeoutD</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
                <span class="n">timeup</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">timeoutD</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># Check if self simNode is locked</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                    <span class="n">self_isLocked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">self_isLocked</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;isLocked&quot;</span><span class="p">)</span>
                <span class="c1"># Check if other simNode is locked</span>
                <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                    <span class="n">other_isLocked</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">locked</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_isLocked</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;isLocked&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">self_isLocked</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: This SimNode </span><span class="si">{}</span><span class="s2"> already locked. Need to wait.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">yield</span> <span class="n">timeoutD</span>
                    <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">other_isLocked</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;VIRTUAL NODE </span><span class="si">{}</span><span class="s2">: Other SimNode </span><span class="si">{}</span><span class="s2"> already locked. Need to wait.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">yield</span> <span class="n">timeoutD</span>
                    <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># Set up the lock acquisition</span>
                    <span class="n">lockD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_nodes</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Yield on both of them</span>
                        <span class="n">gotLock</span><span class="p">,</span> <span class="n">timeoutRes</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">DeferredList</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">lockD</span><span class="p">,</span> <span class="n">timeoutD</span><span class="p">],</span> <span class="n">fireOnOneCallback</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fireOnOneErrback</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">consumeErrors</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Cannot get lock </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlock_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">virtNode</span><span class="p">)</span>
                        <span class="n">timeup</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="k">return</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">timeoutD</span><span class="o">.</span><span class="n">called</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Timing out getting locks.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="n">lockD</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlock_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">virtNode</span><span class="p">)</span>
                            <span class="n">attempts</span> <span class="o">=</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">lockD</span><span class="o">.</span><span class="n">called</span><span class="p">:</span>
                            <span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">timeup</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># We have now acquired the two relevant global node locks. If more than one qubit is locked, all code</span>
        <span class="c1"># will first acquire the global lock, so this should be safe from deadlocks now, so we will not timeout</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_inreg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_inreg</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="c1"># When merging registers, we may need to update the virtual qubits. Remember the original ones so we can</span>
        <span class="c1"># send appropriate unlocks below. (note this assignment must be done after the locks are acquired)</span>
        <span class="n">q1simNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span>
        <span class="n">q1virtNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span>
        <span class="n">q2simNode</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span>
        <span class="n">q2virtNode</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">virtNode</span>

        <span class="c1"># Todo a 2 qubit gate, both qubits must be in the same simulated register. We will merge</span>
        <span class="c1"># registers if this is not already the case.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="p">:</span>
                <span class="c1"># Both qubits are simulated at the same node</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
                    <span class="c1"># Both qubits are both locally simulated, check whether they are in the same register</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span><span class="p">:</span>
                        <span class="c1"># They are even in the same register, just do the gate</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">,</span> <span class="n">localName</span><span class="p">)(</span><span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: 2qubit command demands register merge.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="c1"># Both are local but not in the same register</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">local_merge_regs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="p">)</span>

                        <span class="c1"># After the merge, just do the gate</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">,</span> <span class="n">localName</span><span class="p">)(</span><span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Both are remotely simulated</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: 2qubit command demands remote register merge.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                    <span class="c1"># Fetch the details of the two simulated qubits from remote</span>
                    <span class="p">(</span><span class="n">fNum</span><span class="p">,</span> <span class="n">fNode</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_details&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">tNum</span><span class="p">,</span> <span class="n">tNode</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_details&quot;</span><span class="p">)</span>

                    <span class="c1"># Sanity check: we really have the right simulating node</span>
                    <span class="k">if</span> <span class="n">fNode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">tNode</span> <span class="o">!=</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Inconsistent simulation. Cannot merge.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Inconsistent simulation&quot;</span><span class="p">)</span>

                    <span class="c1"># Merge the remote register according to the simulation IDs of the qubits</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;merge_regs&quot;</span><span class="p">,</span> <span class="n">fNum</span><span class="p">,</span> <span class="n">tNum</span><span class="p">)</span>

                    <span class="c1"># Get the number of the target in the new register</span>
                    <span class="n">targetNum</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_number&quot;</span><span class="p">)</span>

                    <span class="c1"># Execute the 2 qubit gate</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">targetNum</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Remote 2qubit command to </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># They are simulated at two different nodes</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>

                    <span class="c1"># We are the locally simulating node of the first qubit, merge all to us</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: 2qubit command demands merge from remote target sim </span><span class="si">%s</span><span class="s2"> to us.&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="p">(</span><span class="n">fNum</span><span class="p">,</span> <span class="n">fNode</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_details&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fNode</span> <span class="o">!=</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Inconsistent simulation. Cannot merge.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Inconsistent simulation.&quot;</span><span class="p">)</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">remote_merge_from</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fNum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span>
                    <span class="p">)</span>

                    <span class="c1"># Get the number of the target in the new register</span>
                    <span class="n">targetNum</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span>

                    <span class="c1"># Execute the 2 qubit gate</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">,</span> <span class="n">localName</span><span class="p">)(</span><span class="n">targetNum</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>

                    <span class="c1"># We are the locally simulating node of the target qubit, merge all to us</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: 2qubit command demands merge from remote sim </span><span class="si">%s</span><span class="s2"> to us.&quot;</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="p">(</span><span class="n">fNum</span><span class="p">,</span> <span class="n">fNode</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_details&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fNode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Inconsistent simulation. Cannot merge.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Inconsistent simulation.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">remote_merge_from</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fNum</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span>
                    <span class="p">)</span>

                    <span class="c1"># Get the number of the target in the new register</span>
                    <span class="n">targetNum</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span>

                    <span class="c1"># Execute the 2 qubit gate</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">,</span> <span class="n">localName</span><span class="p">)(</span><span class="n">targetNum</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Both qubits are remotely simulated - we will pull both registers to become one local register</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: 2qubit command demands total remote merge from </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Create a new local register</span>
                    <span class="n">newLocalReg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">remote_add_register</span><span class="p">()</span>

                    <span class="c1"># Fetch the detail of the two registers from remote</span>
                    <span class="p">(</span><span class="n">fNum</span><span class="p">,</span> <span class="n">fNode</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_details&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fNode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Inconsistent simulation. Cannot merge.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Inconsistent simulation.&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">tNum</span><span class="p">,</span> <span class="n">tNode</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_details&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tNode</span> <span class="o">!=</span> <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Inconsistent simulation. Cannot merge.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myID</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">quantumError</span><span class="p">(</span><span class="s2">&quot;Inconsistent simulation.&quot;</span><span class="p">)</span>

                    <span class="c1"># Pull the remote registers to this node</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">remote_merge_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fNum</span><span class="p">,</span> <span class="n">newLocalReg</span><span class="p">)</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">target</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">remote_merge_from</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tNum</span><span class="p">,</span> <span class="n">newLocalReg</span>
                    <span class="p">)</span>
                    <span class="c1"># Get the number of the target in the new register</span>
                    <span class="n">targetNum</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span>

                    <span class="c1"># Finally, execute the two qubit gate</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RUN GATE&quot;</span><span class="p">)</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="p">,</span> <span class="n">localName</span><span class="p">)(</span><span class="n">targetNum</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Cannot perform two qubit gate </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># We need to release all the locks, no matter what happened</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlock_inreg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlock_inreg</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlock_nodes</span><span class="p">(</span><span class="n">q1simNode</span><span class="p">,</span> <span class="n">q1virtNode</span><span class="p">,</span> <span class="n">q2simNode</span><span class="p">,</span> <span class="n">q2virtNode</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="virtualQubit.remote_get_number"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_get_number">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_get_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of this qubit in whatever local register it is in. Not useful for the client,</span>
<span class="sd">        but convenient for debugging.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Attempt to manipulate qubits no longer at this node.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">num</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_number&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Connection failed: cannot get qubit number.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">return</span> <span class="n">num</span></div>

<div class="viewcode-block" id="virtualQubit.remote_get_virt_num"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_get_virt_num">[docs]</a>    <span class="k">def</span> <span class="nf">remote_get_virt_num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of the virtual qubit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span></div>

<div class="viewcode-block" id="virtualQubit.remote_get_virtNode"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_get_virtNode">[docs]</a>    <span class="k">def</span> <span class="nf">remote_get_virtNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the virtNode of this virtual qubit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="virtualQubit.remote_get_simNode"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_get_simNode">[docs]</a>    <span class="k">def</span> <span class="nf">remote_get_simNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the simNode of this virtual qubit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="virtualQubit.remote_get_qubit"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_get_qubit">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_get_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the state of this qubit in real and imaginary parts separated. This is required</span>
<span class="sd">        single Twisted cannot natively transfer complex valued objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Attempt to manipulate qubits no longer at this node.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span><span class="p">:</span>
            <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">remote_get_qubit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_qubit&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">remote_err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">reraise_remote_error</span><span class="p">(</span><span class="n">remote_err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VIRTUAL NODE </span><span class="si">%s</span><span class="s2">: Connection failed: cannot get qubit number.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span></div>

<div class="viewcode-block" id="virtualQubit.remote_get_register_RI"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.virtualQubit.remote_get_register_RI">[docs]</a>    <span class="nd">@inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">remote_get_register_RI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simNode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtNode</span><span class="p">:</span>
            <span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">get_register_RI</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simQubit</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">&quot;get_register_RI&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">realM</span><span class="p">,</span> <span class="n">imagM</span></div></div>


<span class="c1">############################################</span>
<span class="c1">#</span>
<span class="c1"># Keeping track of received qubits for CQC</span>


<div class="viewcode-block" id="QubitCQC"><a class="viewcode-back" href="../../../simulaqron.virtNode.html#simulaqron.virtNode.virtual.QubitCQC">[docs]</a><span class="k">class</span> <span class="nc">QubitCQC</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromName</span><span class="p">,</span> <span class="n">toName</span><span class="p">,</span> <span class="n">from_app_id</span><span class="p">,</span> <span class="n">to_app_id</span><span class="p">,</span> <span class="n">new_virt_num</span><span class="p">,</span> <span class="n">rawEntInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fromName</span> <span class="o">=</span> <span class="n">fromName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toName</span> <span class="o">=</span> <span class="n">toName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_app_id</span> <span class="o">=</span> <span class="n">from_app_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_app_id</span> <span class="o">=</span> <span class="n">to_app_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virt_num</span> <span class="o">=</span> <span class="n">new_virt_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawEntInfo</span> <span class="o">=</span> <span class="n">rawEntInfo</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">SimulaQron 3.0.14 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Stephanie Wehner and Axel Dahlberg.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.3.
    </div>
  </body>
</html>